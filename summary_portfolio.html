<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Summary Portfolio</title>
  <style>
    body {
      font-family: sans-serif;
      font-size: 9px;
      margin: 0;
      padding: 10px;
      background-color: #f6f6f6;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    select {
      font-size: 9px;
      padding: 4px;
    }
    .btn-edit {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    td {
      padding: 4px 6px;
      border-bottom: 1px dotted #ccc;
      vertical-align: top;
      font-size: 9px; /* smaller cell text */
    }
    .ticker-name {
      font-weight: bold;
    }
    .name {
      color: #555;
      font-size: 11px;
    }
    .price {
      font-weight: bold;
    }
    .move {
      font-size: 11px;
    }
    tr:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>

<!-- ✅ Only inject this part into search.html -->
<div id="portfolio-summary">
  <div class="header">
    <div>
      <label for="portfolioSelect">Portfolio:</label>
      <select id="portfolioSelect"><option>Loading...</option></select>
    </div>
    <button class="btn-edit" onclick="window.location.href='rc_portfolio.html'" title="Modify Portfolio">✏️</button>
  </div>

  <table id="summaryTable">
    <colgroup>
      <col style="width: 70%">
      <col style="width: 30%">
    </colgroup>  
  </table>
</div>

<script>
const userId = localStorage.getItem("userEmail");
const fmpApiKey = "y9Bthip8mNYaWhrHQp0eTtPX3KltVYPj";

async function loadSummary() {
  const res = await fetch(`https://umd5byy4m3.execute-api.us-east-1.amazonaws.com/rcPortfolio?user_id=${encodeURIComponent(userId)}`);
  const data = await res.json();
  const portfolios = [...new Set(data.map(i => i.portfolio))];
  const dropdown = document.getElementById("portfolioSelect");

  dropdown.innerHTML = portfolios.map(p => `<option value="${p}">${p}</option>`).join("");
  dropdown.addEventListener("change", () => renderSummary(dropdown.value));
  renderSummary(portfolios[0]);
}

async function renderSummary(portfolio) {
  const res = await fetch(`https://umd5byy4m3.execute-api.us-east-1.amazonaws.com/rcPortfolio?user_id=${encodeURIComponent(userId)}`);
  const all = await res.json();
  const rows = all.filter(i => i.portfolio === portfolio && (i.ticker || "").toUpperCase() !== "CASH");

  const today = new Date();
  const holdingPeriods = rows.map(r => {
    const d = /^\d{8}$/.test(r.purchase_date)
      ? new Date(r.purchase_date.slice(0,4), r.purchase_date.slice(4,6) - 1, r.purchase_date.slice(6))
      : new Date(r.purchase_date);
    return Math.max((today - d) / (365.25 * 24 * 3600 * 1000), 0);
  });

  const avgYears = holdingPeriods.length ? holdingPeriods.reduce((a, b) => a + b) / holdingPeriods.length : 0;
  const avgStr = avgYears >= 1 ? `${avgYears.toFixed(1)} yrs` : `${(avgYears * 12).toFixed(0)} mos`;

  // Fetch prices to calculate daily move
  const tickers = rows.map(r => r.ticker.toUpperCase()).join(",");
  const priceRes = await fetch(`https://financialmodelingprep.com/api/v3/quote/${tickers}?apikey=${fmpApiKey}`);
  const prices = await priceRes.json();
  const priceMap = Object.fromEntries(prices.map(p => [p.symbol, p]));

  let weightedMove = 0;
  let totalValue = 0;

  for (const row of rows) {
    const p = priceMap[row.ticker.toUpperCase()];
    const live = p?.price || 0;
    const prev = p?.previousClose || 1;
    const q = parseFloat(row.quantity || 0);
    const mv = q * live;
    const move = (live / prev - 1);
    totalValue += mv;
    weightedMove += mv * move;
  }

  const dailyMovePct = totalValue ? (weightedMove / totalValue * 100).toFixed(2) + "%" : "N/A";

  // Inject into table
  const table = document.getElementById("summaryTable");
  table.innerHTML = `
    <tr><td># of positions:</td><td>${rows.length}</td></tr>
    <tr><td>Avg. holding period:</td><td>${avgStr}</td></tr>
    <tr><td>Daily move (weighted):</td><td style="color: ${dailyMovePct.startsWith("-") ? 'red' : 'green'}">${dailyMovePct}</td></tr>
  `;
}

window.addEventListener("DOMContentLoaded", loadSummary);
</script>


</body>
</html>
