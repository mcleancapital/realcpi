<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Summary Portfolio</title>
  <style>
    body {
      font-family: sans-serif;
      font-size: 13px;
      margin: 0;
      padding: 10px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    select {
      font-size: 13px;
      padding: 4px;
    }
    .btn-edit {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    td {
      padding: 4px 6px;
      border-bottom: 1px solid #ddd;
      vertical-align: top;
    }
    .ticker-name {
      font-weight: bold;
    }
    .name {
      color: #555;
      font-size: 11px;
    }
    .price {
      font-weight: bold;
    }
    .move {
      font-size: 11px;
    }
  </style>
</head>
<body>

<div class="header">
  <div>
    <label for="portfolioSelect">Portfolio:</label>
    <select id="portfolioSelect"><option>Loading...</option></select>
  </div>
  <button class="btn-edit" onclick="window.location.href='rc_portfolio.html'" title="Modify Portfolio">✏️</button>
</div>

<table id="summaryTable"></table>

<script>
const userId = localStorage.getItem("userEmail");
if (!userId) {
  alert("You must be logged in.");
  window.location.href = "/login.html";
}

const baseURL = "https://210jsf4oy1.execute-api.us-east-1.amazonaws.com";
const fmpApiKey = "y9Bthip8mNYaWhrHQp0eTtPX3KltVYPj";

let allHoldings = [];

function populatePortfolioDropdown(portfolios) {
  const dropdown = document.getElementById("portfolioSelect");
  dropdown.innerHTML = portfolios.map(p => `<option value="${p}">${p}</option>`).join("");
  dropdown.value = portfolios[0];
  dropdown.addEventListener("change", () => renderSummary(dropdown.value));
  renderSummary(dropdown.value);
}

async function loadHoldings() {
  const res = await fetch(`https://umd5byy4m3.execute-api.us-east-1.amazonaws.com/rcPortfolio?user_id=${encodeURIComponent(userId)}`);
  allHoldings = await res.json();
  const portfolios = [...new Set(allHoldings.map(i => i.portfolio).filter(Boolean))];
  populatePortfolioDropdown(portfolios);
}

async function renderSummary(selectedPortfolio) {
  const table = document.getElementById("summaryTable");
  table.innerHTML = "";

  let filtered = allHoldings.filter(i => i.portfolio === selectedPortfolio);
  if (filtered.length === 0) {
    table.innerHTML = `<tr><td colspan="2">No holdings in selected portfolio.</td></tr>`;
    return;
  }

  const tickers = [...new Set(filtered.map(i => (i.ticker || "").toUpperCase()))].join(",");
  const res = await fetch(`https://financialmodelingprep.com/api/v3/quote/${tickers}?apikey=${fmpApiKey}`);
  const quotes = await res.json();

  const priceMap = {}, moveMap = {}, nameMap = {}, currencyMap = {};
  quotes.forEach(q => {
    const sym = q.symbol.toUpperCase();
    priceMap[sym] = q.price;
    moveMap[sym] = ((q.price / q.previousClose - 1) * 100).toFixed(2);
    nameMap[sym] = q.name;
    currencyMap[sym] = q.currency || "USD";
  });

  const currencyWeight = {
    CAD: 1,
    USD: 2,
    EUR: 3,
    JPY: 4,
    OTHER: 99
  };

  filtered.sort((a, b) => {
    const aPrivate = a.is_private === true;
    const bPrivate = b.is_private === true;

    if (aPrivate && !bPrivate) return -1;
    if (!aPrivate && bPrivate) return 1;

    const aCurrency = currencyMap[(a.ticker || "").toUpperCase()] || "OTHER";
    const bCurrency = currencyMap[(b.ticker || "").toUpperCase()] || "OTHER";

    return (currencyWeight[aCurrency] || 99) - (currencyWeight[bCurrency] || 99);
  });

  for (const item of filtered) {
    const ticker = (item.ticker || "").toUpperCase();
    const isPrivate = item.is_private === true;
    const name = isPrivate ? (item.name || ticker) : (nameMap[ticker] || ticker);
    const price = isPrivate ? item.custom_price : priceMap[ticker];
    const move = isPrivate ? "" : (moveMap[ticker] + "%");

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>
        <div class="ticker-name" style="color: ${isPrivate ? '#007BFF' : 'inherit'}">${ticker}</div>
        <div class="name">${name}</div>
      </td>
      <td>
        <div class="price">${price !== undefined ? "$" + parseFloat(price).toFixed(2) : "-"}</div>
        <div class="move" style="color: ${move.startsWith('-') ? 'red' : 'green'}">${move}</div>
      </td>
    `;
    table.appendChild(row);
  }
}



  // Sort: Private first
// Build maps
const priceMap = {}, moveMap = {}, nameMap = {}, currencyMap = {};
quotes.forEach(q => {
  const sym = q.symbol.toUpperCase();
  priceMap[sym] = q.price;
  moveMap[sym] = ((q.price / q.previousClose - 1) * 100).toFixed(2);
  nameMap[sym] = q.name;
  currencyMap[sym] = q.currency || "USD";
});

// Define currency weight (lower = higher priority)
const currencyWeight = {
  CAD: 1,
  USD: 2,
  EUR: 3,
  JPY: 4,
  OTHER: 99
};

// Sort: Private first, then by currency
filtered.sort((a, b) => {
  const aPrivate = a.is_private === true;
  const bPrivate = b.is_private === true;

  if (aPrivate && !bPrivate) return -1;
  if (!aPrivate && bPrivate) return 1;

  const aCurrency = currencyMap[(a.ticker || "").toUpperCase()] || "OTHER";
  const bCurrency = currencyMap[(b.ticker || "").toUpperCase()] || "OTHER";

  return (currencyWeight[aCurrency] || 99) - (currencyWeight[bCurrency] || 99);
});


  const tickers = [...new Set(filtered.map(i => (i.ticker || "").toUpperCase()))].join(",");
  const res = await fetch(`https://financialmodelingprep.com/api/v3/quote/${tickers}?apikey=${fmpApiKey}`);
  const quotes = await res.json();

  const priceMap = {}, moveMap = {}, nameMap = {};
  quotes.forEach(q => {
    const sym = q.symbol.toUpperCase();
    priceMap[sym] = q.price;
    moveMap[sym] = ((q.price / q.previousClose - 1) * 100).toFixed(2);
    nameMap[sym] = q.name;
  });

  for (const item of filtered) {
    const ticker = (item.ticker || "").toUpperCase();
    const isPrivate = item.is_private === true;
    const name = isPrivate ? (item.name || ticker) : (nameMap[ticker] || ticker);
    const price = isPrivate ? item.custom_price : priceMap[ticker];
    const move = isPrivate ? "" : (moveMap[ticker] + "%");

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>
        <div class="ticker-name" style="color: ${isPrivate ? '#007BFF' : 'inherit'}">${ticker}</div>
        <div class="name">${name}</div>
      </td>
      <td>
        <div class="price">${price !== undefined ? "$" + parseFloat(price).toFixed(2) : "-"}</div>
        <div class="move" style="color: ${move.startsWith('-') ? 'red' : 'green'}">${move}</div>
      </td>
    `;
    table.appendChild(row);
  }
}

loadHoldings();
</script>

</body>
</html>
