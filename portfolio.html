<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Portfolio</title>
  <style>
    body {
      font-family: sans-serif;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #currencyDisplay {
      font-size: 14px;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px 12px;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #f5f5f5;
    }
    tfoot td {
      font-weight: bold;
      background-color: #eee;
    }
  </style>
</head>
<body>

<div class="header">
  <div>
    <h2>My Portfolio</h2>
    <label for="portfolioSelect">Select Portfolio:</label>
    <select id="portfolioSelect">
      <option value="">Loading...</option>
    </select>
  </div>
  <div id="currencyDisplay">Loading currency...</div>
</div>

<table>
  <thead>
    <tr>
      <th>Ticker</th>
      <th>Name</th>
      <th>Weight</th>
      <th>Quantity*</th>
      <th>Purchase Price*</th>
      <th>Currency</th>
      <th>Purchase Date</th>
      <th>Live Price</th>
      <th>Market Value</th>
      <th>FX</th>
      <th>Market Value (Base)</th>
      <th>Annualized Return (excl. div.)</th>
      <th>Gain/Loss (Base)</th>
      <th>Modify</th>
    </tr>
  </thead>
  <tbody id="portfolioBody"></tbody>
  <tfoot>
    <tr>
      <td colspan="8"></td>
      <td id="totalMV"></td>
      <td></td>
      <td id="totalMVBase"></td>
      <td></td>
      <td id="totalGainLossBase"></td>
    </tr>
  </tfoot>
</table>

<p style="font-size: 12px; color: #555; margin-top: 8px;">
  * The Quantity and the Purchase Price do not get adjusted for splits or reverse splits over time.
  You must adjust these yourself.
</p>
  
<script>
let baseCurrency = "USD";
const userId = "ianmclean@mcleancapital.ca";
const currencyApi = `https://210jsf4oy1.execute-api.us-east-1.amazonaws.com/getUserCurrency?user_id=${encodeURIComponent(userId)}`;
const portfolioUrl = `https://umd5byy4m3.execute-api.us-east-1.amazonaws.com/rcPortfolio?user_id=${encodeURIComponent(userId)}`;
const fmpApiKey = "y9Bthip8mNYaWhrHQp0eTtPX3KltVYPj";

let allHoldings = [];

async function fetchBaseCurrency() {
  try {
    const res = await fetch(currencyApi);
    const data = await res.json();
    baseCurrency = data.base_currency || "USD";
    document.getElementById("currencyDisplay").innerText = `Base Currency: ${baseCurrency}`;
  } catch (e) {
    document.getElementById("currencyDisplay").innerText = `Base Currency: Unknown`;
  }
}

async function fetchFxRate(fromCurrency) {
  if (fromCurrency === baseCurrency) return 1;
  const fxUrl = `https://financialmodelingprep.com/api/v3/quotes/forex?apikey=${fmpApiKey}`;
  try {
    const res = await fetch(fxUrl);
    const data = await res.json();
    const pair = `${fromCurrency}${baseCurrency}`;
    const match = data.find(item => item.symbol === pair);
    return match ? parseFloat(match.price) || 1 : 1;
  } catch (e) {
    console.error(`FX fetch error for ${fromCurrency} to ${baseCurrency}`, e);
    return 1;
  }
}

function formatCurrency(value, currency, decimals = 0) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency,
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  }).format(value);
}

function populatePortfolioDropdown(portfolios) {
  const dropdown = document.getElementById("portfolioSelect");

  // Only populate once
  if (dropdown.dataset.initialized) return;

  dropdown.innerHTML = portfolios.map(p => `<option value="${p}">${p}</option>`).join("");
  dropdown.value = portfolios[0]; // default selected

  dropdown.addEventListener("change", () => renderTable(dropdown.value));
  dropdown.dataset.initialized = "true"; // prevent rebinding
}

async function loadHoldings(initial = false) {
  try {
    const res = await fetch(portfolioUrl);
    allHoldings = await res.json();

    if (!Array.isArray(allHoldings)) throw new Error("Invalid response format");

    const portfolios = [...new Set(allHoldings.map(i => i.portfolio).filter(Boolean))];

    if (initial) {
      populatePortfolioDropdown(portfolios);
      renderTable(portfolios[0]);  // Initial render only
    }

  } catch (error) {
    document.getElementById("portfolioBody").innerHTML =
      `<tr><td colspan='10'>Error loading portfolio: ${error}</td></tr>`;
  }
}

async function renderTable(selectedPortfolio) {
  const tbody = document.getElementById("portfolioBody");
  tbody.innerHTML = "";

  const filtered = allHoldings
    .filter(i => i.portfolio === selectedPortfolio)
    .sort((a, b) => {
      const getPriority = (c) => {
        const cur = (c || "").toUpperCase();
        if (cur === "CAD") return 0;
        if (cur === "USD") return 1;
        return 2;
      };
      return getPriority(a.currency) - getPriority(b.currency);
    });

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan='10'>No data for selected portfolio</td></tr>`;
    return;
  }

  const tickers = [...new Set(filtered.map(i => (i.ticker || "").trim().toUpperCase()))].join(",");
  const priceRes = await fetch(`https://financialmodelingprep.com/api/v3/quote/${tickers}?apikey=${fmpApiKey}`);
  const prices = await priceRes.json();
  const priceMap = {};
  const nameMap = {};


  prices.forEach(p => {
    const symbol = (p.symbol || "").trim().toUpperCase(); // ✅ enforce uppercase
    priceMap[symbol] = p.price;
    nameMap[symbol] = p.name;
  });
  
  for (const item of filtered) {
    const ticker = (item.ticker || "").trim().toUpperCase();  // ✅ enforce uppercase
    if (item.is_private === true && item.custom_price) {
      priceMap[ticker] = parseFloat(item.custom_price);       // ✅ override price
      nameMap[ticker] = item.name || ticker;                  // ✅ override name
    }
  }
  




  

const fxRateCache = {};
const cachedRows = [];
let totalMV = 0, totalMVBase = 0, totalGainLossBase = 0;

// First pass — collect values and compute totals
for (const item of filtered) {
  const ticker = (item.ticker || "").trim().toUpperCase();
  const currency = (item.currency || "USD").toUpperCase();
  const quantity = parseFloat(item.quantity) || 0;
  const purchasePrice = parseFloat(item.purchase_price) || 0;
  const purchaseDate = item.purchase_date || "";
  let livePrice = 0;
  if (item.is_private === true && typeof item.custom_price === "number" && !isNaN(item.custom_price)) {
    livePrice = item.custom_price;
  } else if (priceMap[ticker] !== undefined && priceMap[ticker] !== null) {
    livePrice = parseFloat(priceMap[ticker]) || 0;
  }

  console.log(ticker, "is_private:", item.is_private, "custom_price:", item.custom_price, "→ livePrice:", livePrice);

  
  const marketValue = quantity * livePrice;

  if (!fxRateCache[currency]) {
    fxRateCache[currency] = await fetchFxRate(currency);
  }

  const fxRate = fxRateCache[currency];
  const marketValueBase = marketValue * fxRate;
  const gainLossBase = ((livePrice - purchasePrice) * quantity) * fxRate;

  totalMV += marketValue;
  totalMVBase += marketValueBase;
  totalGainLossBase += gainLossBase;

  cachedRows.push({
    item, ticker, currency, quantity, purchasePrice, purchaseDate, livePrice,
    marketValue, fxRate, marketValueBase, gainLossBase
  });
}


for (const rowData of cachedRows) {
  const {
    item, ticker, currency, quantity, purchasePrice, purchaseDate, livePrice,
    marketValue, fxRate, marketValueBase, gainLossBase
  } = rowData;

  const weight = totalMVBase > 0 ? marketValueBase / totalMVBase : 0;

  const today = new Date();
  let purchaseDateObj = new Date(purchaseDate);
  if (/^\d{8}$/.test(purchaseDate)) {
    purchaseDateObj = new Date(
      parseInt(purchaseDate.slice(0, 4)),
      parseInt(purchaseDate.slice(4, 6)) - 1,
      parseInt(purchaseDate.slice(6, 8))
    );
  }

  let yearsHeld = (today - purchaseDateObj) / (1000 * 60 * 60 * 24 * 365.25);
  if (yearsHeld < 0.01 || !isFinite(yearsHeld)) yearsHeld = 0.01;

  let annualizedReturn = 0;
  if (purchasePrice > 0 && livePrice > 0) {
    annualizedReturn = Math.pow(livePrice / purchasePrice, 1 / yearsHeld) - 1;
  }

  const row = document.createElement("tr");
  const companyName = nameMap[ticker] || item.name || ticker;
  const logoGitHub = `https://raw.githubusercontent.com/mcleancapital/realcpi/main/static/images/${ticker.toLowerCase()}.png`;
  const logoFMP = `https://financialmodelingprep.com/image-stock/${ticker}.png`;




  row.innerHTML = `
    <td style="color: ${item.is_private ? 'blue' : 'inherit'}">${ticker}</td>
    <td style="display: flex; align-items: center; gap: 8px;">
      <img src="${logoGitHub}" alt="${ticker}" style="width: 24px; height: 24px;" onerror="this.onerror=null; this.src='${logoFMP}'" />
      ${companyName}
    </td>
    <td>${(weight * 100).toFixed(1)}%</td>
    <td>${quantity}</td>
    <td>${formatCurrency(purchasePrice, currency, 2)}</td>
    <td>${currency}</td>
    <td>${purchaseDate}</td>
    <td>${formatCurrency(livePrice, currency, 2)}</td>
    <td>${formatCurrency(marketValue, currency)}</td>
    <td>${fxRate.toFixed(4)}</td>
    <td>${formatCurrency(marketValueBase, baseCurrency)}</td>
    <td style="color:${annualizedReturn >= 0 ? 'green' : 'red'}">
      ${(annualizedReturn * 100).toFixed(1)}%
    </td>
    <td style="color:${gainLossBase >= 0 ? 'green' : 'red'}">
      ${gainLossBase >= 0 ? "+" : "-"}${formatCurrency(Math.abs(gainLossBase), baseCurrency)}
    </td>
    <td>
      <button onclick='modifyHolding(${JSON.stringify(item)})' style="cursor:pointer;">✏️</button>
    </td>
  `;

  tbody.appendChild(row);
}

  document.getElementById("totalMV").innerText = formatCurrency(totalMV, baseCurrency);
  document.getElementById("totalMVBase").innerText = formatCurrency(totalMVBase, baseCurrency);
  document.getElementById("totalGainLossBase").innerText =
    (totalGainLossBase >= 0 ? "+" : "-") + formatCurrency(Math.abs(totalGainLossBase), baseCurrency);
}

function modifyHolding(item) {
  alert(`Modify clicked for ${item.ticker} in portfolio "${item.portfolio}"`);

  // Example: open a modal or redirect
  // You could also call an API to update the DynamoDB table
  // fetch('/update-holding', { method: 'POST', body: JSON.stringify({...}) })
}
  
async function main() {
  await fetchBaseCurrency();
  await loadHoldings(true); // Initial load with dropdown
  setInterval(async () => {
    const selected = document.getElementById("portfolioSelect").value;
    await loadHoldings(false); // Refresh holdings only
    renderTable(selected);
  }, 60000);
}

main();
</script>
</body>
</html>
