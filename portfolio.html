<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Portfolio</title>
  <style>
    body {
      font-family: sans-serif;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #currencyDisplay {
      font-size: 14px;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px 12px;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #f5f5f5;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>My Portfolio</h2>
    <div id="currencyDisplay">Loading currency...</div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Ticker</th>
        <th>Quantity</th>
        <th>Purchase Price</th>
        <th>Currency</th>
        <th>FX Rate</th>
        <th>Purchase Date</th>
        <th>Live Price</th>
        <th>Market Value</th>
        <th>Gain/Loss</th>
      </tr>
    </thead>
    <tbody id="portfolioBody">
      <!-- Filled by JavaScript -->
    </tbody>
  </table>

  <script>
    const userId = "ianmclean@mcleancapital.ca";
    const currencyApi = `https://YOUR_API_URL/getUserCurrency?user_id=${encodeURIComponent(userId)}`;

    async function fetchBaseCurrency() {
      try {
        const res = await fetch(currencyApi);
        const data = await res.json();
        const baseCurrency = data.base_currency || "USD";
        document.getElementById("currencyDisplay").innerText = `Base Currency: ${baseCurrency}`;
      } catch (e) {
        document.getElementById("currencyDisplay").innerText = `Base Currency: Unknown`;
      }
    }

    async function loadPortfolio() {
      const portfolioUrl = `https://umd5byy4m3.execute-api.us-east-1.amazonaws.com/rcPortfolio?user_id=${encodeURIComponent(userId)}`;
      const fmpApiKey = "y9Bthip8mNYaWhrHQp0eTtPX3KltVYPj";

      try {
        const res = await fetch(portfolioUrl);
        const holdings = await res.json();

        const tbody = document.getElementById("portfolioBody");
        tbody.innerHTML = "";

        if (!Array.isArray(holdings)) {
          tbody.innerHTML = "<tr><td colspan='10'>Invalid server response</td></tr>";
          return;
        }

        const cleanedTickers = holdings
          .map(item => (item.ticker || "").trim().toUpperCase())
          .filter(t => !!t);

        const tickers = [...new Set(cleanedTickers)].join(",");

        const priceRes = await fetch(`https://financialmodelingprep.com/api/v3/quote-short/${tickers}?apikey=${fmpApiKey}`);
        const prices = await priceRes.json();
        const priceMap = Array.isArray(prices)
          ? Object.fromEntries(prices.map(p => [p.symbol.toUpperCase(), p.price]))
          : {};

        holdings.forEach(item => {
          const ticker = (item.ticker || "").trim().toUpperCase();
          const livePrice = parseFloat(priceMap[ticker] || 0);
          const quantity = parseFloat(item.quantity) || 0;
          const purchasePrice = parseFloat(item.purchase_price) || 0;
          const marketValue = quantity * livePrice;
          const gainLoss = (livePrice - purchasePrice) * quantity;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${ticker}</td>
            <td>${quantity}</td>
            <td>${purchasePrice.toFixed(2)}</td>
            <td>${item.currency || ""}</td>
            <td>${item.fx_rate || ""}</td>
            <td>${item.purchase_date || ""}</td>
            <td>${livePrice.toFixed(2)}</td>
            <td>${marketValue.toFixed(2)}</td>
            <td style="color:${gainLoss >= 0 ? 'green' : 'red'}">
              ${gainLoss >= 0 ? "+" : ""}${gainLoss.toFixed(2)}
            </td>
          `;
          tbody.appendChild(row);
        });

      } catch (error) {
        document.getElementById("portfolioBody").innerHTML =
          `<tr><td colspan='10'>Error loading portfolio: ${error}</td></tr>`;
      }
    }

    // Run both
    fetchBaseCurrency();
    loadPortfolio();
    setInterval(loadPortfolio, 30000);
  </script>
</body>
</html>
