<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Portfolio</title>
  <style>
    body {
      font-family: sans-serif;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #currencyDisplay {
      font-size: 14px;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px 12px;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #f5f5f5;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>My Portfolio</h2>
    <div id="currencyDisplay">Loading currency...</div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Ticker</th>
        <th>Quantity</th>
        <th>Purchase Price</th>
        <th>Currency</th>
        <th>Purchase Date</th>
        <th>Live Price</th>
        <th>Market Value</th>
        <th>FX</th>
        <th>Market Value (Base)</th>
        <th>Gain/Loss (Base)</th>
      </tr>
    </thead>
    <tbody id="portfolioBody">
      <!-- Filled by JavaScript -->
    </tbody>
  </table>

  <script>
    const userId = "ianmclean@mcleancapital.ca";
    const currencyApi = `https://210jsf4oy1.execute-api.us-east-1.amazonaws.com/getUserCurrency?user_id=${encodeURIComponent(userId)}`;
    const fmpApiKey = "y9Bthip8mNYaWhrHQp0eTtPX3KltVYPj";

    let baseCurrency = "USD";

    async function fetchBaseCurrency() {
      try {
        const res = await fetch(currencyApi);
        const data = await res.json();
        baseCurrency = data.base_currency || "USD";
        document.getElementById("currencyDisplay").innerText = `Base Currency: ${baseCurrency}`;
      } catch (e) {
        document.getElementById("currencyDisplay").innerText = `Base Currency: Unknown`;
      }
    }

    async function fetchFxRate(fromCurrency) {
      if (fromCurrency === baseCurrency) return 1;
      const pair = `${fromCurrency}${baseCurrency}`;
      const fxUrl = `https://financialmodelingprep.com/api/v3/quote-short/${pair}?apikey=${fmpApiKey}`;
      try {
        const res = await fetch(fxUrl);
        const data = await res.json();
        return parseFloat(data.price) || 1;
      } catch (e) {
        console.error(`Failed to fetch FX rate for ${pair}`, e);
        return 1;
      }
    }

    async function loadPortfolio() {
      const portfolioUrl = `https://umd5byy4m3.execute-api.us-east-1.amazonaws.com/rcPortfolio?user_id=${encodeURIComponent(userId)}`;

      try {
        const res = await fetch(portfolioUrl);
        const holdings = await res.json();

        const tbody = document.getElementById("portfolioBody");
        tbody.innerHTML = "";

        if (!Array.isArray(holdings)) {
          tbody.innerHTML = "<tr><td colspan='10'>Invalid server response</td></tr>";
          return;
        }

        const tickers = [...new Set(
          holdings.map(item => (item.ticker || "").trim().toUpperCase())
        )].join(",");

        const priceRes = await fetch(`https://financialmodelingprep.com/api/v3/quote-short/${tickers}?apikey=${fmpApiKey}`);
        const prices = await priceRes.json();
        const priceMap = Array.isArray(prices)
          ? Object.fromEntries(prices.map(p => [p.symbol.toUpperCase(), p.price]))
          : {};

        const fxRateCache = {};

        for (const item of holdings) {
          const ticker = (item.ticker || "").trim().toUpperCase();
          const currency = (item.currency || "USD").toUpperCase();
          const quantity = parseFloat(item.quantity) || 0;
          const purchasePrice = parseFloat(item.purchase_price) || 0;
          const purchaseDate = item.purchase_date || "";

          const livePrice = parseFloat(priceMap[ticker]) || 0;
          const marketValue = quantity * livePrice;

          if (!fxRateCache[currency]) {
            fxRateCache[currency] = await fetchFxRate(currency);
          }

          const fxRate = fxRateCache[currency];
          const marketValueBase = marketValue * fxRate;
          const gainLossBase = ((livePrice - purchasePrice) * quantity) * fxRate;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${ticker}</td>
            <td>${quantity}</td>
            <td>${purchasePrice.toFixed(2)}</td>
            <td>${currency}</td>
            <td>${purchaseDate}</td>
            <td>${livePrice.toFixed(2)}</td>
            <td>${marketValue.toFixed(2)}</td>
            <td>${fxRate.toFixed(4)}</td>
            <td>${marketValueBase.toFixed(2)}</td>
            <td style="color:${gainLossBase >= 0 ? 'green' : 'red'}">
              ${gainLossBase >= 0 ? "+" : ""}${gainLossBase.toFixed(2)}
            </td>
          `;
          tbody.appendChild(row);
        }

      } catch (error) {
        document.getElementById("portfolioBody").innerHTML =
          `<tr><td colspan='10'>Error loading portfolio: ${error}</td></tr>`;
      }
    }

    async function main() {
      await fetchBaseCurrency();
      await loadPortfolio();
      setInterval(loadPortfolio, 30000);
    }

    main();
  </script>
</body>
</html>
