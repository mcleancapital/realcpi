<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Portfolio</title>
  <style>
    body {
      font-family: sans-serif;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #currencyDisplay {
      font-size: 14px;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px 12px;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #f5f5f5;
    }
    tfoot td {
      font-weight: bold;
      background-color: #eee;
    }
  </style>
</head>
<body>

<div class="header">
  <div>
    <h2>My Portfolio</h2>
    <label for="portfolioSelect">Select Portfolio:</label>
    <select id="portfolioSelect">
      <option value="">Loading...</option>
    </select>
  </div>
  <div id="currencyDisplay">Loading currency...</div>
</div>

  
  <table>
    <thead>
      <tr>
        <th>Ticker</th>
        <th>Quantity</th>
        <th>Purchase Price</th>
        <th>Currency</th>
        <th>Purchase Date</th>
        <th>Live Price</th>
        <th>Market Value</th>
        <th>FX</th>
        <th>Market Value (Base)</th>
        <th>Gain/Loss (Base)</th>
      </tr>
    </thead>
    <tbody id="portfolioBody"></tbody>
    <tfoot>
      <tr>
        <td colspan="6"></td>
        <td id="totalMV"></td>
        <td></td>
        <td id="totalMVBase"></td>
        <td id="totalGainLossBase"></td>
      </tr>
    </tfoot>
  </table>

  <script>
let baseCurrency = "USD";
const userId = "ianmclean@mcleancapital.ca";
const currencyApi = `https://210jsf4oy1.execute-api.us-east-1.amazonaws.com/getUserCurrency?user_id=${encodeURIComponent(userId)}`;
const portfolioUrl = `https://umd5byy4m3.execute-api.us-east-1.amazonaws.com/rcPortfolio?user_id=${encodeURIComponent(userId)}`;
const fmpApiKey = "y9Bthip8mNYaWhrHQp0eTtPX3KltVYPj";

let allHoldings = [];

async function fetchBaseCurrency() {
  try {
    const res = await fetch(currencyApi);
    const data = await res.json();
    baseCurrency = data.base_currency || "USD";
    document.getElementById("currencyDisplay").innerText = `Base Currency: ${baseCurrency}`;
  } catch (e) {
    document.getElementById("currencyDisplay").innerText = `Base Currency: Unknown`;
  }
}

async function fetchFxRate(fromCurrency) {
  if (fromCurrency === baseCurrency) return 1;
  const fxUrl = `https://financialmodelingprep.com/api/v3/quotes/forex?apikey=${fmpApiKey}`;
  try {
    const res = await fetch(fxUrl);
    const data = await res.json();
    const pair = `${fromCurrency}${baseCurrency}`;
    const match = data.find(item => item.symbol === pair);
    return match ? parseFloat(match.price) || 1 : 1;
  } catch (e) {
    console.error(`FX fetch error for ${fromCurrency} to ${baseCurrency}`, e);
    return 1;
  }
}

function formatCurrency(value, currency) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency,
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(value);
}

function populatePortfolioDropdown(portfolios) {
  const dropdown = document.getElementById("portfolioSelect");

  // Only populate once
  if (dropdown.dataset.initialized) return;

  // Count CAD vs USD for each portfolio
  const currencyBias = {};
  for (const portfolio of portfolios) {
    const holdings = allHoldings.filter(h => h.portfolio === portfolio);
    const cadCount = holdings.filter(h => (h.currency || "").toUpperCase() === "CAD").length;
    const usdCount = holdings.filter(h => (h.currency || "").toUpperCase() === "USD").length;
    currencyBias[portfolio] = cadCount - usdCount; // positive = CAD-leaning
  }

  // Sort portfolios: CAD-leaning first, then USD-leaning
  portfolios.sort((a, b) => {
    const biasA = currencyBias[a] || 0;
    const biasB = currencyBias[b] || 0;
    return biasB - biasA;
  });

  dropdown.innerHTML = portfolios.map(p => `<option value="${p}">${p}</option>`).join("");
  dropdown.value = portfolios[0];

  dropdown.addEventListener("change", () => renderTable(dropdown.value));
  dropdown.dataset.initialized = "true";
}


async function loadHoldings(initial = false) {
  try {
    const res = await fetch(portfolioUrl);
    allHoldings = await res.json();

    if (!Array.isArray(allHoldings)) throw new Error("Invalid response format");

    const portfolios = [...new Set(allHoldings.map(i => i.portfolio).filter(Boolean))];

    if (initial) {
      populatePortfolioDropdown(portfolios);
      renderTable(portfolios[0]);  // Initial render only
    }

  } catch (error) {
    document.getElementById("portfolioBody").innerHTML =
      `<tr><td colspan='10'>Error loading portfolio: ${error}</td></tr>`;
  }
}

async function renderTable(selectedPortfolio) {
  const tbody = document.getElementById("portfolioBody");
  tbody.innerHTML = "";

  const filtered = allHoldings.filter(i => i.portfolio === selectedPortfolio);
  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan='10'>No data for selected portfolio</td></tr>`;
    return;
  }

  const tickers = [...new Set(filtered.map(i => (i.ticker || "").trim().toUpperCase()))].join(",");
  const priceRes = await fetch(`https://financialmodelingprep.com/api/v3/quote-short/${tickers}?apikey=${fmpApiKey}`);
  const prices = await priceRes.json();
  const priceMap = Object.fromEntries(prices.map(p => [p.symbol.toUpperCase(), p.price]));

  const fxRateCache = {};
  let totalMV = 0, totalMVBase = 0, totalGainLossBase = 0;

  for (const item of filtered) {
    const ticker = (item.ticker || "").trim().toUpperCase();
    const currency = (item.currency || "USD").toUpperCase();
    const quantity = parseFloat(item.quantity) || 0;
    const purchasePrice = parseFloat(item.purchase_price) || 0;
    const purchaseDate = item.purchase_date || "";
    const livePrice = parseFloat(priceMap[ticker]) || 0;
    const marketValue = quantity * livePrice;

    if (!fxRateCache[currency]) {
      fxRateCache[currency] = await fetchFxRate(currency);
    }

    const fxRate = fxRateCache[currency];
    const marketValueBase = marketValue * fxRate;
    const gainLossBase = ((livePrice - purchasePrice) * quantity) * fxRate;

    totalMV += marketValue;
    totalMVBase += marketValueBase;
    totalGainLossBase += gainLossBase;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${ticker}</td>
      <td>${quantity}</td>
      <td>${formatCurrency(purchasePrice, currency)}</td>
      <td>${currency}</td>
      <td>${purchaseDate}</td>
      <td>${formatCurrency(livePrice, currency)}</td>
      <td>${formatCurrency(marketValue, currency)}</td>
      <td>${fxRate.toFixed(4)}</td>
      <td>${formatCurrency(marketValueBase, baseCurrency)}</td>
      <td style="color:${gainLossBase >= 0 ? 'green' : 'red'}">
        ${gainLossBase >= 0 ? "+" : "-"}${formatCurrency(Math.abs(gainLossBase), baseCurrency)}
      </td>
    `;
    tbody.appendChild(row);
  }

  document.getElementById("totalMV").innerText = formatCurrency(totalMV, baseCurrency);
  document.getElementById("totalMVBase").innerText = formatCurrency(totalMVBase, baseCurrency);
  document.getElementById("totalGainLossBase").innerText =
    (totalGainLossBase >= 0 ? "+" : "-") + formatCurrency(Math.abs(totalGainLossBase), baseCurrency);
}

async function main() {
  await fetchBaseCurrency();
  await loadHoldings(true); // Initial load with dropdown
  setInterval(async () => {
    const selected = document.getElementById("portfolioSelect").value;
    await loadHoldings(false); // Refresh holdings only
    renderTable(selected);
  }, 30000);
}

main();
  </script>
</body>
</html>
